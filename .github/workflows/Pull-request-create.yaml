name: Pull request create

on:
  create:
    branches:
      - "Release/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/Release/')
    env:
      GITHUB_REF: ${{ github.ref_name == '' && '' || github.ref_name }}
    steps:
      - name: Extract semantic version
        id: version
        run: |
          # Strip the leading "Release/"
          raw="${GITHUB_REF#refs/heads/Release/}"
          # Simple semver regex (allows pre-release and build metadata)
          if [[ "$raw" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$ ]]; then
            echo "version=$raw" >> $GITHUB_OUTPUT
          else
            echo "Invalid semantic version: $raw"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Extract last commit description
        id: commit
        run: |
          commit_description=$(git log -1 --pretty=format:"%B" | tail -n +2)
          {
          echo "changelog<<EOF"
          echo "$commit_description"
          echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD: "Release/${{ steps.version.outputs.version }}"
          TITLE: "Release/${{ steps.version.outputs.version }}"
          BASE: master
        run: |
          set -euo pipefail
          BODY=$(cat <<'EOF'
          ## What's Changed:
          ${{ steps.commit.outputs.changelog }}
          EOF
          )

          # Check if a PR already exists
          existing_pr_number=$(gh pr list --base "$BASE" --head "$HEAD" --state open --json number --jq '.[0].number' || true)
          if [ -n "${existing_pr_number:-}" ]; then
            echo "PR #$existing_pr_number already exists between $HEAD -> $BASE. Skipping creation."
            exit 0
          fi

          # Create the PR
          gh pr create \
            --base "$BASE" \
            --head "$HEAD" \
            --title "$TITLE" \
            --body "$BODY" \
            --draft=false
